{% extends "dashboard_base.html" %}

{% block dashboard_content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<h1>Editar Producto: {{ product.name }}</h1>
<div class="form-container">
    <form method="POST" enctype="multipart/form-data">
        {{ form.hidden_tag() }}
        
        <div class="form-group">
            {{ form.name.label }}
            {{ form.name(class="form-control") }}
        </div>
        <div class="form-group">
            {{ form.price.label }}
            {{ form.price(class="form-control") }}
        </div>
        <div class="form-group">
            {{ form.category.label }}
            {{ form.category(class="form-control") }}
        </div>
        <div class="form-group">
            {{ form.stock.label }}
            {{ form.stock(class="form-control") }}
        </div>
        <div class="form-group">
            {{ form.description.label }}
            {{ form.description(class="form-control", rows=4) }}
        </div>
        <div class="form-group">
            <p>Imagen Actual:</p>
            <img src="{{ url_for('static', filename='img/' + product.image_file) }}" style="max-width: 150px; border-radius: 5px;">
            <br><br>
            {{ form.image.label }}
            {{ form.image(class="form-control") }}
        </div>
        <div class="form-group">
            <label>Fecha y Hora de Encuentro (GMT-3)</label>
            <div style="display: flex; gap: 10px;">
                {{ form.meetup_date(class="form-control") }}
                {{ form.meetup_time(class="form-control") }}
            </div>
        </div>
        <div class="form-group">
            <label>Ubicación de Encuentro</label>
            <div id="map"></div>
            {{ form.meetup_location() }}
        </div>

        {{ form.submit(class="submit-btn") }}
    </form>
</div>

<style>
    .form-container { background-color: rgba(0,0,0,0.2); padding: 30px; border-radius: 10px; max-width: 800px; margin: auto; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: bold; }
    .form-control { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #6c63ff; background-color: #333; color: white; box-sizing: border-box; }
    #map { height: 400px; border-radius: 10px; background-color: #555; }
    .submit-btn { width: 100%; padding: 15px; font-size: 1.2em; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 20px; }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var map = L.map('map', { crs: L.CRS.Simple, minZoom: -2 });
        var bounds = [[-1000, -1000], [1000, 1000]];
        L.imageOverlay("{{ url_for('static', filename='img/mi_mapa.png') }}", bounds).addTo(map);
        map.fitBounds(bounds);
        var marker;
        var locationInput = document.getElementById('meetup_location');

        // Si ya hay una ubicación guardada, la mostramos
        if (locationInput.value) {
            var coords = locationInput.value.split(',');
            var latLng = L.latLng(coords[0], coords[1]);
            marker = L.marker(latLng).addTo(map);
            map.setView(latLng, 0);
        }

        map.on('click', function(e) {
            if (marker) {
                map.removeLayer(marker);
            }
            marker = L.marker(e.latlng).addTo(map);
            locationInput.value = e.latlng.lat + ',' + e.latlng.lng;
        });
    });
</script>
{% endblock %}