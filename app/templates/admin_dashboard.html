{% extends "dashboard_base.html" %}

{% block dashboard_content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<h1>Pedidos Pendientes de Aprobación</h1>

<div class="product-list-container">
    {% for product in products %}
    <div class="pending-product-item">
        <div class="product-info">
            <img src="{{ url_for('static', filename='img/' + product.image_file) }}" class="product-img">
            <div>
                <h3>{{ product.name }}</h3>
                <p>Vendedor: <strong>{{ product.seller.username }}</strong> | Precio: ${{ "%.2f"|format(product.price) }} | Stock: {{ product.stock }}</p>
                <p>Fecha de Entrega: {{ product.meetup_datetime.strftime('%d/%m/%Y a las %H:%M') if product.meetup_datetime else 'No especificada' }}</p>
            </div>
        </div>
        <div class="delivery-map" id="map-{{ product.id }}" data-lat="{{ product.meetup_location_x }}" data-lon="{{ product.meetup_location_y }}">
        </div>
        <div class="product-actions">
            <form action="{{ url_for('main.approve_product', product_id=product.id) }}" method="POST" style="display:inline;">
                <button type="submit" class="btn-approve">Aprobar</button>
            </form>
            <form action="{{ url_for('main.reject_product', product_id=product.id) }}" method="POST" style="display:inline;">
                <button type="submit" class="btn-reject">Rechazar</button>
            </form>
        </div>
    </div>
    {% else %}
    <p style="text-align:center; padding: 20px;">No hay productos pendientes de aprobación.</p>
    {% endfor %}
</div>

<style>
    .pending-product-item { background-color: rgba(0,0,0,0.2); border-radius: 10px; padding: 20px; margin-bottom: 20px; display: grid; grid-template-columns: 3fr 2fr; gap: 20px; align-items: center;}
    .product-info { display: flex; align-items: center; gap: 20px; }
    .product-img { width: 100px; height: 100px; object-fit: cover; border-radius: 5px; }
    .delivery-map { height: 200px; border-radius: 5px; }
    .product-actions { grid-column: 1 / -1; display: flex; justify-content: flex-end; gap: 10px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px; margin-top: 15px;}
    .btn-approve, .btn-reject { color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
    .btn-approve { background-color: #28a745; }
    .btn-reject { background-color: #dc3545; }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var mapElements = document.querySelectorAll('.delivery-map');
        var mapImage = "{{ url_for('static', filename='img/mi_mapa.png') }}";
        var bounds = [[-1000, -1000], [1000, 1000]];

        mapElements.forEach(function(mapEl) {
            var lat = mapEl.dataset.lat;
            var lon = mapEl.dataset.lon;

            if (lat && lon) {
                var map = L.map(mapEl.id, {
                    crs: L.CRS.Simple,
                    minZoom: -2,
                    zoomControl: false,
                    attributionControl: false
                });

                L.imageOverlay(mapImage, bounds).addTo(map);
                
                var latLng = L.latLng(lat, lon);
                L.marker(latLng).addTo(map);
                map.setView(latLng, 0);
            } else {
                mapEl.innerHTML = '<p style="text-align:center; color:#888;">Ubicación no especificada.</p>';
            }
        });
    });
</script>
{% endblock %}