{% extends "dashboard_base.html" %}

{% block dashboard_content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<style>
    .checkout-container { display: grid; grid-template-columns: 2fr 1fr; gap: 30px; }
    .checkout-form, .order-summary { background-color: rgba(0,0,0,0.2); padding: 20px; border-radius: 10px; }
    #map { height: 400px; border-radius: 10px; background-color: #555; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; }
    .form-group input, .form-group textarea { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #6c63ff; background-color: #333; color: white; box-sizing: border-box; }
    .order-summary ul { list-style: none; padding: 0; }
    .order-summary li { display: flex; justify-content: space-between; margin-bottom: 10px; }
    .order-summary .total { font-size: 1.5em; font-weight: bold; color: #00aaff; margin-top: 20px; }
    .checkout-btn { width: 100%; padding: 15px; font-size: 1.2em; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 20px; }
</style>

<h1>Finalizar Compra</h1>
<form method="POST">
    <div class="checkout-container">
        <div class="checkout-form">
            <h2>Detalles de la Entrega</h2>
            <div class="form-group">
                <label for="keyword">Palabra Clave</label>
                <input type="text" id="keyword" name="keyword" required>
            </div>
             <div class="form-group">
                <label>Fecha y Hora del Pedido (GMT-3)</label>
                <input type="datetime-local" name="delivery_datetime" required>
            </div>
            <div class="form-group">
                <label>Ubicación en el Mapa</label>
                <div id="map"></div>
                <input type="hidden" id="location_x" name="location_x" required>
                <input type="hidden" id="location_y" name="location_y" required>
            </div>
            <div class="form-group">
                <label for="extra_details">Detalles Extras (cómo vistes, qué carro tienes, etc.)</label>
                <textarea id="extra_details" name="extra_details" rows="4"></textarea>
            </div>
        </div>
        <div class="order-summary">
            <h2>Resumen del Pedido</h2>
            <ul>
                {% for item in cart_items.values() %}
                <li>
                    <span>{{ item.product.name }} x {{ item.quantity }}</span>
                    <span>${{ "%.2f"|format(item.product.price * item.quantity) }}</span>
                </li>
                {% endfor %}
            </ul>
            <hr>
            <div class="total">
                <span>Total (+10% Tarifa):</span>
                <span>${{ "%.2f"|format(final_price) }}</span>
            </div>
             <button type="submit" class="checkout-btn">Confirmar Compra</button>
        </div>
    </div>
</form>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var map = L.map('map', {
            crs: L.CRS.Simple,
            minZoom: -2
        });
        var bounds = [[-1000, -1000], [1000, 1000]];
        L.imageOverlay("{{ url_for('static', filename='img/mi_mapa.png') }}", bounds).addTo(map);
        map.fitBounds(bounds);
        var marker;

        map.on('click', function(e) {
            if (marker) {
                map.removeLayer(marker);
            }
            marker = L.marker(e.latlng).addTo(map);
            document.getElementById('location_x').value = e.latlng.lat;
            document.getElementById('location_y').value = e.latlng.lng;
        });
    });
</script>
{% endblock %}